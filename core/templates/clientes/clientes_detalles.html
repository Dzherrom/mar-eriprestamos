{% extends "layouts/base.html" %}
{% load static %}
{% block content %}
<div class="container">
    <div class="main-container">
        <!-- Tarjeta de Información General -->
        <div class="card-general">
            <h5>Información General</h5>
            <div class="card-general-info"> 
                <div>
                    <p>Nombre y Apellido: {{ cliente.nombre }} {{ cliente.apellido }}</p>
                    <p>Cedula: {{ cliente.cedula }}</p>
                </div>
                <div>
                    <p>Prestamos Activos: {{ prestamos_activos }}</p>
                    <p>Prestamos Pagados: {{ prestamos_pagados }}</p>
                </div>
                <div>
                    <p>Balance General: {{ balance }}</p>
                    <p>Balance Prestado: {{ balance_total }}</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Tarjeta de Transacciones -->
            <div class="card-transacciones col">
                <h5>Transacciones</h5>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha de Pago</th>
                            <th>Moneda</th>
                            <th>Tipo de Pago</th>
                            <th>Referencia</th>
                            <th>Monto</th>
                            <th>Monto a pagar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                        <tr>
                            <td>{{ pago.fecha_pago }}</td>
                            <td>{{ pago.moneda }}</td>
                            <td>{{ pago.tipo_pago }}</td>
                            <td><a href="#">{{ pago.referencia }}</a></td>
                            <td>${{ pago.monto }}</td>
                            <td>{{ pago.prestamo.monto_a_pagar }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No hay pagos registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Tarjeta de Total Pagado -->
            <div class="card-total-pagado col">
                <h5>Prestamos</h5>
                <p>Seleccione un préstamo:</p>
                <select id="prestamo-select">
                    {% for prestamo in prestamos %}
                        <option value="{{ prestamo.id }}">Préstamo {{ prestamo.id }} - Monto: ${{ prestamo.monto }}</option>
                    {% empty %}
                        <option value="">No hay préstamos disponibles</option>
                    {% endfor %}
                </select>
                <div id="grafico-total-pagado" style="width: 300px; height: 300px;">
                    <!-- Aquí se mostrará el gráfico en círculo -->
                </div>
            </div>

            <!-- Tarjeta de Pagos Totales -->
            <div class="card-pagos-totales col">
                <h5>Pagos Totales</h5>
                <div id="grafico-pagos-totales">
                    <!-- Aquí se mostrará el gráfico en círculo con el monto total de todos los préstamos activos -->
                </div>
            </div>
        </div>
        <div class="container">
            <div class="detalles-container">
                <div class="left-column">
                    <div class="card-left">
                        <h5>Información Básica</h5>
                        <p>Tipo de persona: {{ cliente.tipo_persona }}</p>
                        <p>Nombre: {{ cliente.nombre }}</p>
                        <p>Apellido: {{ cliente.apellido }}</p>
                        <p>Genero: {{ cliente.nombre }}</p>
                        <p>Fecha de Nacimiento: {{ cliente.fecha_nacimiento }}</p>
                    </div>
                    <div class="card-left">
                        <h5>Información Adicional</h5>
                        <p>Modificado Por: </p>
                        <p>Ultimo pago:  {{ fecha_ultimo_pago }} </p>
                        <p>Prestamos activos: {{ prestamos_activos }} </p>
                        <p>Prestamos pagados: {{ prestamos_pagados }} </p>
                    </div>
                </div>
                <div class="right-column">
                    <div class="card-right">
                        <h5>Direcciones</h5>
                        <p>Direccion 1: {{ cliente.direccion_1 }}</p>
                        <p>Direccion 2: {{ cliente.direccion_2 }}</p>
        
                    </div>
                    <div class="card-right">
                        <h5>Documento de Identidad</h5>
                        <p>Cedula de identidad: {{ cliente.cedula }}</p>
                        <p>RIF: {{ cliente.rif }}</p>
                    </div>
                    <div class="card-right">
                        <h5>Información de Contacto</h5>
                        <p>Correo 1: {{ cliente.email_1 }}</p>
                        <p>Correo 2: {{ cliente.email_2 }}</p>
                        <p>Numero de telefono: {{ cliente.numero_telefono }}</p>
                        <p>Numero local: {{ cliente.numero_local }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-general">
            <div class="clientes">
                <h5>Clientes</h5>
                <div style="display: grid; grid-template-columns: 1fr auto; margin-bottom: 10px;">
                    <div></div>
                <input type="text" id="searchInputPagados" placeholder="Buscar por cliente..." class="form-control" style="margin-bottom: 10px; max-width: 100%; ">
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="th sort-both">ID</th>
                            <th class="th sort-both">Nombre</th>
                            <th class="th sort-both">Apellido</th>
                            <th class="th sort-both">Cedula</th>
                            <th class="th sort-both">Prestamos activos</th>
                            <th class="th sort-both">Prestamos pagados</th>
                            <th class="th sort-both">Balance</th>
                        </tr>
                    </thead>
                    <tbody id="pagadosTableBody">
                        {% for clientes in clientes %}
                        <tr>
                            <td><a href="{% url 'cliente_detalles' clientes.id %}">{{ clientes.id }}</a></td>
                            <td>{{ clientes.nombre }}</td>
                            <td>{{ clientes.apellido }}</td>
                            <td>{{ clientes.cedula }}</td>
                            <td>{{ clientes.prestamos_activos }}</td>
                            <td>{{ clientes.prestamos_pagados }}</td>
                            <td>${{ clientes.balance }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No hay clientes registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const prestamoSelect = document.getElementById('prestamo-select');
    const graficoTotalPagado = document.getElementById('grafico-total-pagado');
    let chart = null; // Variable para almacenar la instancia del gráfico

    prestamoSelect.addEventListener('change', function () {
        const prestamoId = this.value;

        // Verificar si se seleccionó un préstamo válido
        if (!prestamoId) {
            graficoTotalPagado.innerHTML = '<p>No hay préstamos disponibles.</p>';
            return;
        }

        // Hacer una solicitud AJAX a la API
        fetch(`/api/prestamos/${prestamoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los datos del préstamo');
                }
                return response.json();
            })
            .then(data => {
                // Destruir el gráfico anterior si existe
                if (chart) {
                    chart.destroy();
                }

                // Crear un canvas para el gráfico
                const ctx = document.createElement('canvas');
                graficoTotalPagado.innerHTML = ''; // Limpiar el contenido anterior
                graficoTotalPagado.appendChild(ctx); // Agregar el canvas al div

                // Crear el gráfico circular con Chart.js
                chart = new Chart(ctx, {
                    type: 'pie',  // Tipo de gráfico circular
                    data: {
                        labels: ['Monto Pagado', 'Monto Pendiente'],  // Etiquetas
                        datasets: [{
                            label: 'Monto',
                            data: [data.monto_pago, data.monto_a_pagar],  // Datos
                            backgroundColor: ['#36A2EB', '#FF6384'],  // Colores
                            borderColor: ['#36A2EB', '#FF6384'],  // Bordes
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,  // Evita que el gráfico se ajuste automáticamente
                        plugins: {
                            legend: {
                                position: 'top',  // Posición de la leyenda
                            },
                            title: {
                                display: true,
                                text: `Préstamo ${prestamoId} - Monto Total: $${data.monto_prestamo}`  // Título del gráfico
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                graficoTotalPagado.innerHTML = '<p>Error al cargar los datos del préstamo.</p>';
            });
    });

    // Cargar datos iniciales para el primer préstamo (opcional)
    if (prestamoSelect.value) {
        prestamoSelect.dispatchEvent(new Event('change'));
    }
});
    </script>
{% endblock content %}